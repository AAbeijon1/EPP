<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Detección y Seguimiento de Objetos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 5px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
        }
        .drop-zone:hover {
            background: #f8f9fa;
        }
        .drop-zone.active {
            border-color: #0d6efd;
            background: #e9ecef;
        }
        .detection-card {
            margin-bottom: 15px;
        }
        .detection-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .tab-content {
            padding: 20px 0;
        }
        .chart-container {
            height: 300px;
            margin-bottom: 20px;
        }
        .video-container {
            max-width: 100%;
            margin-top: 20px;
        }
        .video-container video {
            max-width: 100%;
        }
        .track-id-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        /* Estilos para la imagen de carga */
        .loading-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            height: 200px;
            width: 100%;
            border-radius: 5px;
        }
        /* Mejorar la visualización de las imágenes */
        .card-img-top {
            height: 200px;
            object-fit: cover;
            width: 100%;
        }
        /* Estilos para la barra de progreso */
        .progress {
            height: 25px;
            margin-bottom: 15px;
        }
        .progress-bar {
            font-size: 14px;
            line-height: 25px;
        }
        /* Estilos para los filtros de clase */
        .class-filters {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .class-checkbox {
            margin-right: 15px;
            margin-bottom: 10px;
            display: inline-block;
        }
        /* Estilo para las alertas de seguridad */
        .safety-alert {
            background-color: #ffecb5;
            border-left: 4px solid #e6a700;
            padding: 10px 15px;
            margin-bottom: 15px;
        }
        .safety-critical {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        /* Estilo para el contador de infracciones */
        .violation-counter {
            font-size: 18px;
            font-weight: bold;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        /* Estilo para el video procesado */
        .processed-video {
            width: 100%;
            height: auto;
            max-height: 300px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .image-popup {
            display: block;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 2px;
            transition: transform 0.2s;
        }
        .image-popup:hover {
            transform: scale(1.05);
            border-color: #007bff;
        }
        /* Estilo para las clases de alerta */
        .alert-class-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 4px;
            background-color: #f8f9fa;
            border-left: 3px solid #007bff;
        }
        .alert-class-item.selected {
            background-color: #e2f0ff;
            border-left-color: #0d6efd;
        }
        .alert-class-item:hover {
            background-color: #e9ecef;
            cursor: pointer;
        }
        .alert-evidence-container {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .alert-evidence-image {
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            transition: transform 0.2s;
        }
        .alert-evidence-image:hover {
            transform: scale(1.05);
            border-color: #0d6efd;
        }
        /* Estilo para botones de acción de video */
        .video-actions {
            margin-top: 10px;
            margin-bottom: 15px;
        }
        /* Estilo para mensajes de error de video */
        .video-error {
            color: #dc3545;
            margin-top: 10px;
            padding: 10px;
            background-color: #f8d7da;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Sistema de Detección y Seguimiento de Objetos</h1>
        
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="detection-tab" data-bs-toggle="tab" data-bs-target="#detection" type="button" role="tab" aria-controls="detection" aria-selected="true">Detección</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="video-tab" data-bs-toggle="tab" data-bs-target="#video" type="button" role="tab" aria-controls="video" aria-selected="false">Video Procesado</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="false">Tablero</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="gallery-tab" data-bs-toggle="tab" data-bs-target="#gallery" type="button" role="tab" aria-controls="gallery" aria-selected="false">Galería</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="safety-tab" data-bs-toggle="tab" data-bs-target="#safety" type="button" role="tab" aria-controls="safety" aria-selected="false">Informe de Detecciones y Alertas</button>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <!-- Pestaña de Detección -->
            <div class="tab-pane fade show active" id="detection" role="tabpanel" aria-labelledby="detection-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">Cargar Modelo YOLOv8</div>
                            <div class="card-body">
                                <div id="model-drop-zone" class="drop-zone mb-3">
                                    <p>Arrastra y suelta tu archivo de modelo YOLOv8 (.pt) aquí o haz clic para seleccionar</p>
                                    <input type="file" id="model-upload" accept=".pt" style="display: none;">
                                </div>
                                <div id="model-info" class="alert alert-info d-none">
                                    <span id="model-name"></span>
                                </div>
                            </div>
                        </div>
                        <div class="card mb-4">
                            <div class="card-header">Cargar Video</div>
                            <div class="card-body">
                                <div id="drop-zone" class="drop-zone mb-3">
                                    <p>Arrastra y suelta un archivo de video aquí o haz clic para seleccionar</p>
                                    <input type="file" id="video-upload" accept="video/*" style="display: none;">
                                </div>
                                <div id="upload-info" class="alert alert-info d-none">
                                    <span id="file-name"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">Configuración de Detección</div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="threshold" class="form-label">Umbral de Confianza: <span id="threshold-value">0.50</span></label>
                                    <input type="range" class="form-range" id="threshold" min="0.1" max="0.9" step="0.1" value="0.5">
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="show-tracks" checked>
                                    <label class="form-check-label" for="show-tracks">
                                        Mostrar IDs de Seguimiento y Trayectorias
                                    </label>
                                </div>
                                <button id="detect-btn" class="btn btn-primary" disabled>Detectar con Seguimiento</button>
                                
                                <!-- Video procesado (ubicado aquí según la flecha) -->
                                <div id="video-preview-container" class="mt-3 d-none">
                                    <h6>Video Procesado:</h6>
                                    <div class="video-error" id="preview-video-error">
                                        Error al cargar el video. Intente verlo en la pestaña "Video Procesado".
                                    </div>
                                    <video id="preview-video" class="processed-video" controls style="width: 100%; max-height: 250px; border: 2px solid #007bff;"></video>
                                    <div class="video-actions">
                                        <button id="view-full-video-btn" class="btn btn-sm btn-outline-primary">Ver en pantalla completa</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Barra de progreso para el procesamiento -->
                <div id="progress-container" class="d-none">
                    <div class="progress">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                            0%
                        </div>
                    </div>
                    <p id="progress-status">Inicializando...</p>
                </div>
                
                <!-- Filtros de clase -->
                <div id="class-filters-container" class="class-filters d-none">
                    <h5>Filtrar por Tipo de Objeto:</h5>
                    <div id="class-checkboxes">
                        <!-- Los checkboxes se generarán dinámicamente -->
                    </div>
                    <button id="apply-filters-btn" class="btn btn-sm btn-outline-primary mt-2">Aplicar Filtros</button>
                    <button id="clear-filters-btn" class="btn btn-sm btn-outline-secondary mt-2 ms-2">Limpiar Filtros</button>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">Resultados de Detección</div>
                    <div class="card-body">
                        <div id="results-container">
                            <p>No hay detecciones aún. Carga un modelo y un video, luego haz clic en "Detectar con Seguimiento".</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pestaña de Video Procesado -->
            <div class="tab-pane fade" id="video" role="tabpanel" aria-labelledby="video-tab">
                <div class="card mb-4">
                    <div class="card-header">Video Procesado con Detecciones</div>
                    <div class="card-body">
                        <div id="full-video-container" class="text-center">
                            <p id="video-status-message">No hay video procesado disponible. Ejecuta la detección primero.</p>
                            <div class="video-error" id="full-video-error">
                                Error al cargar el video. Intente recargar la página o ejecutar la detección nuevamente.
                            </div>
                            <div class="video-actions mb-3">
                                <button id="reload-video-btn" class="btn btn-outline-primary">Recargar Video</button>
                                <button id="download-video-btn" class="btn btn-outline-success ms-2">Descargar Video</button>
                            </div>
                            <video id="full-preview-video" class="img-fluid" controls style="max-height: 70vh; border: 1px solid #ddd; border-radius: 5px;"></video>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pestaña de Tablero -->
            <div class="tab-pane fade" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">Distribución de Clases</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="class-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">Confianza Promedio por Clase</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="confidence-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">Detecciones a lo Largo del Tiempo</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="time-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">Distribución de IDs de Seguimiento</div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="track-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pestaña de Galería -->
            <div class="tab-pane fade" id="gallery" role="tabpanel" aria-labelledby="gallery-tab">
                <div class="card mb-4">
                    <div class="card-header">Buscar Detecciones</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="input-group mb-3">
                                    <input type="text" id="search-input" class="form-control" placeholder="Buscar por clase (ej. casco, chaleco)">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group mb-3">
                                    <input type="number" id="track-id-input" class="form-control" placeholder="Filtrar por ID de Seguimiento">
                                </div>
                            </div>
                            <div class="col-md-12">
                                <button class="btn btn-outline-secondary" type="button" id="search-btn">Buscar</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row" id="gallery-container">
                    <!-- Las tarjetas de detección se añadirán aquí -->
                </div>
            </div>
            
            <!-- Pestaña de Informe de Seguridad -->
            <div class="tab-pane fade" id="safety" role="tabpanel" aria-labelledby="safety-tab">
                <div class="card mb-4">
                    <div class="card-header">Informe de Detecciones y Alertas</div>
                    <div class="card-body">
                        <div class="violation-counter mb-3">
                            Total de Alertas Configuradas: <span id="violation-count">0</span>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5>Resumen de Detecciones:</h5>
                                <div id="compliance-summary" class="mb-4">
                                    <p>No hay datos disponibles. Ejecuta la detección primero.</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5>Configuración de Alertas:</h5>
                                <div class="card">
                                    <div class="card-body">
                                        <p>Selecciona las clases que deseas monitorear con alertas:</p>
                                        <div id="alert-classes-container">
                                            <!-- Las clases para alertar se generarán dinámicamente -->
                                            <p>No hay clases disponibles. Ejecuta la detección primero.</p>
                                        </div>
                                        <button id="apply-alerts-btn" class="btn btn-sm btn-primary mt-2">Aplicar Configuración</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h5>Alertas Configuradas:</h5>
                        <div id="safety-alerts">
                            <!-- Las alertas de seguridad se añadirán aquí -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para mostrar imágenes en tamaño completo -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModalLabel">Evidencia de Detección</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="/placeholder.svg" class="img-fluid" alt="Evidencia de detección">
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let currentVideoPath = null;
        let currentModelPath = null;
        let classChart = null;
        let confidenceChart = null;
        let timeChart = null;
        let trackChart = null;
        let statusCheckInterval = null;
        let detectionClasses = new Set();
        let allDetections = [];
        let selectedClasses = new Set();
        let alertClasses = new Set(); // Clases seleccionadas para generar alertas
        let imageModal = null;
        let processedVideoUrl = null;
        
        // Elementos DOM
        const modelDropZone = document.getElementById('model-drop-zone');
        const modelUpload = document.getElementById('model-upload');
        const modelInfo = document.getElementById('model-info');
        const modelName = document.getElementById('model-name');
        const dropZone = document.getElementById('drop-zone');
        const videoUpload = document.getElementById('video-upload');
        const uploadInfo = document.getElementById('upload-info');
        const fileName = document.getElementById('file-name');
        const thresholdSlider = document.getElementById('threshold');
        const thresholdValue = document.getElementById('threshold-value');
        const showTracks = document.getElementById('show-tracks');
        const detectBtn = document.getElementById('detect-btn');
        const resultsContainer = document.getElementById('results-container');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressStatus = document.getElementById('progress-status');
        const videoPreviewContainer = document.getElementById('video-preview-container');
        const previewVideo = document.getElementById('preview-video');
        const previewVideoError = document.getElementById('preview-video-error');
        const classFiltersContainer = document.getElementById('class-filters-container');
        const classCheckboxes = document.getElementById('class-checkboxes');
        const applyFiltersBtn = document.getElementById('apply-filters-btn');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        const searchInput = document.getElementById('search-input');
        const trackIdInput = document.getElementById('track-id-input');
        const searchBtn = document.getElementById('search-btn');
        const galleryContainer = document.getElementById('gallery-container');
        const violationCount = document.getElementById('violation-count');
        const complianceSummary = document.getElementById('compliance-summary');
        const safetyAlerts = document.getElementById('safety-alerts');
        const alertClassesContainer = document.getElementById('alert-classes-container');
        const applyAlertsBtn = document.getElementById('apply-alerts-btn');
        const fullPreviewVideo = document.getElementById('full-preview-video');
        const videoStatusMessage = document.getElementById('video-status-message');
        const fullVideoError = document.getElementById('full-video-error');
        const reloadVideoBtn = document.getElementById('reload-video-btn');
        const downloadVideoBtn = document.getElementById('download-video-btn');
        const viewFullVideoBtn = document.getElementById('view-full-video-btn');
        
        // Inicializar el modal de imagen
        document.addEventListener('DOMContentLoaded', function() {
            imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
            
            // Configurar el evento para mostrar imágenes en el modal
            document.getElementById('modalImage').addEventListener('click', function() {
                imageModal.hide();
            });
            
            // Ocultar botones de video inicialmente
            reloadVideoBtn.style.display = 'none';
            downloadVideoBtn.style.display = 'none';
            
            // Configurar eventos para botones de video
            reloadVideoBtn.addEventListener('click', function() {
                reloadVideo();
            });
            
            downloadVideoBtn.addEventListener('click', function() {
                downloadVideo();
            });
            
            viewFullVideoBtn.addEventListener('click', function() {
                // Cambiar a la pestaña de video
                document.getElementById('video-tab').click();
            });
        });
        
        // Event listeners para carga de modelo
        modelDropZone.addEventListener('click', () => modelUpload.click());
        modelDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            modelDropZone.classList.add('active');
        });
        modelDropZone.addEventListener('dragleave', () => {
            modelDropZone.classList.remove('active');
        });
        modelDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            modelDropZone.classList.remove('active');
            
            if (e.dataTransfer.files.length) {
                handleModelUpload(e.dataTransfer.files[0]);
            }
        });
        
        modelUpload.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleModelUpload(e.target.files[0]);
            }
        });
        
        // Event listeners para carga de video
        dropZone.addEventListener('click', () => videoUpload.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('active');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('active');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('active');
            
            if (e.dataTransfer.files.length) {
                handleFileUpload(e.dataTransfer.files[0]);
            }
        });
        
        videoUpload.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFileUpload(e.target.files[0]);
            }
        });
        
        // Event listeners para el umbral de confianza
        thresholdSlider.addEventListener('input', () => {
            thresholdValue.textContent = thresholdSlider.value;
        });
        
        detectBtn.addEventListener('click', runDetection);
        searchBtn.addEventListener('click', searchDetections);
        applyFiltersBtn.addEventListener('click', applyClassFilters);
        clearFiltersBtn.addEventListener('click', clearClassFilters);
        applyAlertsBtn.addEventListener('click', generateSafetyReport);
        
        // Eventos de cambio de pestaña para cargar datos
        document.getElementById('video-tab').addEventListener('click', function() {
            // Si hay un video procesado, asegurarse de que se muestre correctamente
            if (processedVideoUrl) {
                reloadVideo();
            }
        });
        document.getElementById('dashboard-tab').addEventListener('click', loadDashboardData);
        document.getElementById('gallery-tab').addEventListener('click', () => searchDetections());
        document.getElementById('safety-tab').addEventListener('click', function() {
            generateAlertClassOptions();
            generateSafetyReport();
        });
        
        // Funciones
        function handleModelUpload(file) {
            if (!file.name.endsWith('.pt')) {
                alert('Por favor, carga un archivo de modelo YOLOv8 (.pt).');
                return;
            }
            
            const formData = new FormData();
            formData.append('model', file);
            
            modelInfo.classList.remove('d-none');
            modelName.textContent = `Cargando: ${file.name}`;
            
            fetch('/upload_model', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentModelPath = data.model_path;
                    modelName.textContent = `Modelo cargado: ${file.name}`;
                    updateDetectButton();
                } else {
                    alert('Error al cargar el modelo: ' + data.error);
                    modelInfo.classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar el modelo. Por favor, inténtalo de nuevo.');
                modelInfo.classList.add('d-none');
            });
        }
        
        function handleFileUpload(file) {
            if (!file.type.startsWith('video/')) {
                alert('Por favor, carga un archivo de video.');
                return;
            }
            
            const formData = new FormData();
            formData.append('video', file);
            
            uploadInfo.classList.remove('d-none');
            fileName.textContent = `Cargando: ${file.name}`;
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentVideoPath = data.video_path;
                    fileName.textContent = `Listo: ${file.name}`;
                    updateDetectButton();
                } else {
                    alert('Error al cargar: ' + data.error);
                    uploadInfo.classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar. Por favor, inténtalo de nuevo.');
                uploadInfo.classList.add('d-none');
            });
        }
        
        function updateDetectButton() {
            detectBtn.disabled = !(currentModelPath && currentVideoPath);
        }
        
        // Función para iniciar la detección y monitorear el progreso
        function runDetection() {
            if (!currentModelPath) {
                alert('Por favor, carga primero un modelo YOLOv8.');
                return;
            }
            
            if (!currentVideoPath) {
                alert('Por favor, carga primero un video.');
                return;
            }
            
            detectBtn.disabled = true;
            resultsContainer.innerHTML = '<p>Inicializando proceso de detección...</p>';
            progressContainer.classList.remove('d-none');
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            progressStatus.textContent = 'Iniciando proceso de detección...';
            
            // Ocultar contenedores de resultados previos
            videoPreviewContainer.classList.add('d-none');
            classFiltersContainer.classList.add('d-none');
            
            // Reiniciar variables globales
            detectionClasses = new Set();
            allDetections = [];
            selectedClasses = new Set();
            alertClasses = new Set();
            processedVideoUrl = null;
            
            fetch('/detect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    video_path: currentVideoPath,
                    model_path: currentModelPath,
                    threshold: thresholdSlider.value,
                    show_tracks: showTracks.checked
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Iniciar monitoreo del progreso
                    startProgressMonitoring();
                } else {
                    alert('Error en la detección: ' + data.error);
                    console.error('Detalles del error:', data.traceback);
                    resultsContainer.innerHTML = '<p>Error en la detección. Los detalles del error se han registrado en la consola.</p>';
                    progressContainer.classList.add('d-none');
                    detectBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error de Fetch:', error);
                alert('Error en la detección. Por favor, revisa la consola para más detalles.');
                detectBtn.disabled = false;
                resultsContainer.innerHTML = '<p>Ocurrió un error durante la detección. Revisa la consola para más detalles.</p>';
                progressContainer.classList.add('d-none');
            });
        }
        
        // Función para monitorear el progreso del procesamiento
        function startProgressMonitoring() {
            // Limpiar cualquier intervalo existente
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            // Verificar el estado cada 2 segundos
            statusCheckInterval = setInterval(() => {
                fetch('/processing_status')
                    .then(response => response.json())
                    .then(status => {
                        // Actualizar barra de progreso
                        const progress = status.progress || 0;
                        progressBar.style.width = `${progress}%`;
                        progressBar.textContent = `${progress}%`;
                        progressBar.setAttribute('aria-valuenow', progress);
                        
                        // Actualizar mensaje de estado
                        switch(status.status) {
                            case 'loading_model':
                                progressStatus.textContent = 'Cargando modelo YOLOv8...';
                                break;
                            case 'processing_video':
                                progressStatus.textContent = `Procesando video: ${status.current_frame}/${status.total_frames} frames`;
                                break;
                            case 'completed':
                                progressStatus.textContent = '¡Procesamiento completado con éxito!';
                                clearInterval(statusCheckInterval);
                                displayResults(status);
                                detectBtn.disabled = false;
                                break;
                            case 'error':
                                progressStatus.textContent = `Error: ${status.error}`;
                                clearInterval(statusCheckInterval);
                                resultsContainer.innerHTML = `<p class="text-danger">Error: ${status.error}</p>`;
                                detectBtn.disabled = false;
                                break;
                            default:
                                progressStatus.textContent = 'Procesando...';
                        }
                    })
                    .catch(error => {
                        console.error('Error al verificar el estado del procesamiento:', error);
                        progressStatus.textContent = 'Error al verificar el estado';
                    });
            }, 2000);
        }
        
        // Función para recargar el video
        function reloadVideo() {
            if (!processedVideoUrl) return;
            
            // Añadir timestamp para evitar caché
            const timestamp = new Date().getTime();
            const videoUrl = `${processedVideoUrl}?t=${timestamp}`;
            
            console.log('Recargando video desde:', videoUrl);
            
            // Actualizar el video en la pestaña de video procesado
            fullPreviewVideo.src = videoUrl;
            fullPreviewVideo.load();
            
            // Mostrar botones y ocultar mensaje
            reloadVideoBtn.style.display = 'inline-block';
            downloadVideoBtn.style.display = 'inline-block';
            videoStatusMessage.style.display = 'none';
            fullVideoError.style.display = 'none';
            
            // Manejar errores
            fullPreviewVideo.onerror = function(e) {
                console.error('Error al cargar el video completo:', e);
                fullVideoError.style.display = 'block';
            };
        }
        
        // Función para descargar el video
        function downloadVideo() {
            if (!processedVideoUrl) return;
            
            // Crear un enlace temporal para descargar
            const a = document.createElement('a');
            a.href = processedVideoUrl;
            a.download = processedVideoUrl.split('/').pop().split('?')[0]; // Extraer nombre del archivo
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // Función para mostrar los resultados
        function displayResults(data) {
            if (!data.detections || data.detections.length === 0) {
                resultsContainer.innerHTML = '<p>No se detectaron objetos en el video.</p>';
                progressContainer.classList.add('d-none');
                return;
            }
            
            // Guardar todas las detecciones
            allDetections = data.detections.filter(detection => detection.class !== 'frame');
            
            // Recopilar todas las clases únicas
            allDetections.forEach(detection => {
                detectionClasses.add(detection.class);
                selectedClasses.add(detection.class); // Inicialmente seleccionar todas las clases
            });
            
        // Mostrar el video procesado
        if (data.output_video) {
            // Usar la ruta directa del video
            let videoPath = `/outputs/${data.output_video_filename}`;
            
            // Guardar la URL del video procesado
            processedVideoUrl = videoPath;
            
            console.log('Cargando video desde:', videoPath);
            
            // Mostrar el contenedor de video
            videoPreviewContainer.classList.remove('d-none');
            
            // Actualizar el video en la pestaña de detección
            previewVideo.src = videoPath;
            previewVideo.load();
            
            // Actualizar el video en la pestaña de video procesado
            fullPreviewVideo.src = videoPath;
            fullPreviewVideo.load();
            videoStatusMessage.style.display = 'none';
            
            // Mostrar botones
            reloadVideoBtn.style.display = 'inline-block';
            downloadVideoBtn.style.display = 'inline-block';
        }
            
            // Generar checkboxes para filtrar por clase
            generateClassFilters();
            
            // Generar opciones de clases para alertas
            generateAlertClassOptions();
            
            // Mostrar resultados filtrados
            displayFilteredResults();
            
            // Ocultar barra de progreso
            progressContainer.classList.add('d-none');
            
            // Actualizar datos del tablero
            loadDashboardData();
            
            // Generar informe de seguridad
            generateSafetyReport();
        }
        
        // Función para generar los filtros de clase
        function generateClassFilters() {
            if (detectionClasses.size === 0) return;
            
            let html = '';
            detectionClasses.forEach(className => {
                html += `
                    <div class="class-checkbox">
                        <input type="checkbox" id="class-${className}" class="form-check-input" value="${className}" checked>
                        <label for="class-${className}" class="form-check-label">${className}</label>
                    </div>
                `;
            });
            
            classCheckboxes.innerHTML = html;
            classFiltersContainer.classList.remove('d-none');
            
            // Añadir event listeners a los checkboxes
            document.querySelectorAll('.class-checkbox input').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedClasses.add(this.value);
                    } else {
                        selectedClasses.delete(this.value);
                    }
                    displayFilteredResults(); // Actualizar resultados al cambiar filtros
                });
            });
        }
        
        // Función para generar opciones de clases para alertas
        function generateAlertClassOptions() {
            if (detectionClasses.size === 0) {
                alertClassesContainer.innerHTML = '<p>No hay clases disponibles. Ejecuta la detección primero.</p>';
                return;
            }
            
            let html = '';
            detectionClasses.forEach(className => {
                const isSelected = alertClasses.has(className);
                
                html += `
                    <div class="alert-class-item ${isSelected ? 'selected' : ''}" data-class="${className}">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="alert-${className}" 
                                   value="${className}" ${isSelected ? 'checked' : ''}>
                            <label class="form-check-label" for="alert-${className}">
                                ${className}
                            </label>
                        </div>
                    </div>
                `;
            });
            
            alertClassesContainer.innerHTML = html;
            
            // Añadir event listeners a los checkboxes
            document.querySelectorAll('.alert-class-item input').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const parentItem = this.closest('.alert-class-item');
                    if (this.checked) {
                        alertClasses.add(this.value);
                        parentItem.classList.add('selected');
                    } else {
                        alertClasses.delete(this.value);
                        parentItem.classList.remove('selected');
                    }
                });
            });
            
            // También permitir hacer clic en el div completo
            document.querySelectorAll('.alert-class-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    // Evitar activación si se hizo clic directamente en el checkbox
                    if (e.target.type !== 'checkbox') {
                        const checkbox = this.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        
                        // Disparar el evento change manualmente
                        const event = new Event('change');
                        checkbox.dispatchEvent(event);
                    }
                });
            });
        }

        // Función para aplicar filtros de clase
        function applyClassFilters() {
            displayFilteredResults();
        }
        
        // Función para limpiar filtros de clase
        function clearClassFilters() {
            document.querySelectorAll('.class-checkbox input').forEach(checkbox => {
                checkbox.checked = true;
            });
            
            selectedClasses = new Set(detectionClasses);
            displayFilteredResults();
        }
        
        // Función para mostrar resultados filtrados
        function displayFilteredResults() {
            // Filtrar detecciones por clases seleccionadas
            const filteredDetections = allDetections.filter(detection => 
                selectedClasses.has(detection.class)
            );
            
            if (filteredDetections.length === 0) {
                resultsContainer.innerHTML = '<p>No hay detecciones que coincidan con los filtros seleccionados.</p>';
                return;
            }
            
            // Agrupar detecciones por ID de seguimiento
            const detectionsByTrack = {};
            filteredDetections.forEach(detection => {
                const trackId = detection.track_id !== null ? `Seguimiento ${detection.track_id}` : 'Sin seguimiento';
                if (!detectionsByTrack[trackId]) {
                    detectionsByTrack[trackId] = [];
                }
                detectionsByTrack[trackId].push(detection);
            });
            
            let html = `<h4>Se encontraron ${Object.keys(detectionsByTrack).length} objetos con seguimiento:</h4>`;
            
            for (const [trackId, detections] of Object.entries(detectionsByTrack)) {
                html += `
                    <div class="mb-4">
                        <h5>${trackId} (${detections.length} frames)</h5>
                        <div class="row">
                `;
                
                detections.slice(0, 4).forEach(detection => {
                    // Usar base64 si está disponible, de lo contrario usar la ruta de la imagen
                    let imgSrc;
                    if (detection.image_base64) {
                        imgSrc = `data:image/jpeg;base64,${detection.image_base64}`;
                    } else {
                        // Añadir timestamp para evitar caché
                        const timestamp = new Date().getTime();
                        imgSrc = `${detection.image_path}?t=${timestamp}`;
                    }
                    
                    html += `
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="card">
                                <div class="position-relative">
                                    <img src="${imgSrc}" class="card-img-top" alt="Detección" 
                                         onclick="showImageModal('${imgSrc}')"
                                         onerror="this.onerror=null; this.src='/static/placeholder.jpg?t=${new Date().getTime()}'; console.error('Error al cargar imagen: ${imgSrc}');">
                                    <span class="track-id-badge">ID: ${detection.track_id}</span>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">Clase: ${detection.class}<br>Confianza: ${(detection.confidence * 100).toFixed(1)}%</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            resultsContainer.innerHTML = html;
        }
        
        // Función para mostrar imagen en modal
        function showImageModal(imgSrc) {
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imgSrc;
            imageModal.show();
        }
        
        function loadDashboardData() {
            fetch('/dashboard_stats')
                .then(response => response.json())
                .then(data => {
                    updateDashboardCharts(data);
                })
                .catch(error => {
                    console.error('Error al cargar datos del tablero:', error);
                });
        }
        
        function updateDashboardCharts(data) {
            // Gráfico de distribución de clases
            const classLabels = Object.keys(data.class_distribution);
            const classValues = Object.values(data.class_distribution);
            
            if (classChart) {
                classChart.destroy();
            }
            
            classChart = new Chart(document.getElementById('class-chart'), {
                type: 'bar',
                data: {
                    labels: classLabels,
                    datasets: [{
                        label: 'Número de Detecciones',
                        data: classValues,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
            
            // Gráfico de confianza promedio
            const confLabels = Object.keys(data.avg_confidence);
            const confValues = Object.values(data.avg_confidence).map(val => val * 100);
            
            if (confidenceChart) {
                confidenceChart.destroy();
            }
            
            confidenceChart = new Chart(document.getElementById('confidence-chart'), {
                type: 'bar',
                data: {
                    labels: confLabels,
                    datasets: [{
                        label: 'Confianza Promedio (%)',
                        data: confValues,
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
            
            // Gráfico de serie temporal
            const timeLabels = Object.keys(data.time_series);
            const timeValues = Object.values(data.time_series);
            
            if (timeChart) {
                timeChart.destroy();
            }
            
            timeChart = new Chart(document.getElementById('time-chart'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Detecciones por Día',
                        data: timeValues,
                        fill: false,
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
            
            // Gráfico de distribución de IDs de seguimiento
            if (data.track_distribution) {
                const trackLabels = Object.keys(data.track_distribution);
                const trackValues = Object.values(data.track_distribution);
                
                if (trackChart) {
                    trackChart.destroy();
                }
                
                trackChart = new Chart(document.getElementById('track-chart'), {
                    type: 'bar',
                    data: {
                        labels: trackLabels,
                        datasets: [{
                            label: 'Detecciones por ID de Seguimiento',
                            data: trackValues,
                            backgroundColor: 'rgba(153, 102, 255, 0.5)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            }
        }
        
        function searchDetections() {
            const searchTerm = searchInput.value.trim();
            const trackId = trackIdInput.value.trim();
            
            let url = `/search_detections?class=${encodeURIComponent(searchTerm)}`;
            if (trackId) {
                url += `&track_id=${encodeURIComponent(trackId)}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    displayGallery(data.detections);
                })
                .catch(error => {
                    console.error('Error al buscar detecciones:', error);
                    galleryContainer.innerHTML = '<p class="text-danger">Error al cargar detecciones.</p>';
                });
        }
        
        function displayGallery(detections) {
            if (detections.length === 0) {
                galleryContainer.innerHTML = '<p>No se encontraron detecciones.</p>';
                return;
            }
            
            let html = '';
            
            detections.forEach(detection => {
                if (detection.class === 'frame') return; // Ignorar frames de galería
                
                const date = new Date(detection.timestamp).toLocaleString();
                
                // Usar base64 si está disponible, de lo contrario usar la ruta de la imagen
                let imgSrc;
                if (detection.image_base64) {
                    imgSrc = `data:image/jpeg;base64,${detection.image_base64}`;
                } else {
                    // Añadir timestamp para evitar caché
                    const timestamp = new Date().getTime();
                    imgSrc = `${detection.image_path}?t=${timestamp}`;
                }
                
                html += `
                    <div class="col-md-3 col-sm-6">
                        <div class="card detection-card">
                            <div class="position-relative">
                                <img src="${imgSrc}" class="detection-image" alt="${detection.class}"
                                     onclick="showImageModal('${imgSrc}')"
                                     onerror="this.onerror=null; this.src='/static/placeholder.jpg?t=${new Date().getTime()}'; console.error('Error al cargar imagen: ${imgSrc}');">
                                ${detection.track_id !== null ? `<span class="track-id-badge">ID: ${detection.track_id}</span>` : ''}
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">${detection.class}</h5>
                                <p class="card-text">
                                    Confianza: ${(detection.confidence * 100).toFixed(1)}%<br>
                                    Fecha: ${date}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            galleryContainer.innerHTML = html;
        }
        
        // Función para generar el informe de seguridad
        function generateSafetyReport() {
            if (allDetections.length === 0) {
                complianceSummary.innerHTML = '<p>No hay datos disponibles. Ejecuta la detección primero.</p>';
                safetyAlerts.innerHTML = '';
                violationCount.textContent = '0';
                return;
            }
            
            // Contar detecciones por clase
            const classCounts = {};
            allDetections.forEach(detection => {
                if (!classCounts[detection.class]) {
                    classCounts[detection.class] = 0;
                }
                classCounts[detection.class]++;
            });
            
            // Generar resumen de detecciones
            let summaryHtml = '<ul class="list-group mb-3">';
            for (const [className, count] of Object.entries(classCounts)) {
                // Destacar las clases que tienen alertas configuradas
                const hasAlert = alertClasses.has(className);
                summaryHtml += `
                    <li class="list-group-item d-flex justify-content-between align-items-center ${hasAlert ? 'list-group-item-warning' : ''}">
                        ${className} ${hasAlert ? '<span class="badge bg-warning text-dark me-2">Alerta</span>' : ''}
                        <span class="badge bg-primary rounded-pill">${count}</span>
                    </li>
                `;
            }
            summaryHtml += '</ul>';
            
            complianceSummary.innerHTML = summaryHtml;
            
            // Buscar objetos en las clases seleccionadas para alertas
            const alertItems = [];
            
            // Agrupar detecciones por clase
            const detectionsByClass = {};
            allDetections.forEach(detection => {
                if (!detectionsByClass[detection.class]) {
                    detectionsByClass[detection.class] = [];
                }
                detectionsByClass[detection.class].push(detection);
            });
            
            // Generar alertas para cada clase seleccionada
            alertClasses.forEach(className => {
                if (detectionsByClass[className] && detectionsByClass[className].length > 0) {
                    alertItems.push({
                        className: className,
                        count: detectionsByClass[className].length,
                        detections: detectionsByClass[className]
                    });
                }
            });
            
            // Actualizar contador de alertas
            violationCount.textContent = alertItems.reduce((total, v) => total + v.count, 0).toString();
            
            // Generar alertas basadas en las clases seleccionadas
            let alertsHtml = '';
            
            if (alertItems.length > 0) {
                alertItems.forEach(item => {
                    let imagesHtml = '<div class="row mt-2">';
                    
                    // Mostrar hasta 4 imágenes por alerta
                    item.detections.slice(0, 4).forEach(detection => {
                        let imgSrc;
                        if (detection.image_base64) {
                            imgSrc = `data:image/jpeg;base64,${detection.image_base64}`;
                        } else {
                            const timestamp = new Date().getTime();
                            imgSrc = `${detection.image_path}?t=${timestamp}`;
                        }
                        
                        imagesHtml += `
                            <div class="col-md-3 col-sm-6 mb-2">
                                <img src="${imgSrc}" class="img-fluid rounded alert-evidence-image" 
                                     alt="Evidencia" onclick="showImageModal('${imgSrc}')"
                                     onerror="this.onerror=null; this.src='/static/placeholder.jpg';">
                                <div class="text-center">
                                    <small>ID: ${detection.track_id || 'N/A'}</small>
                                </div>
                            </div>
                        `;
                    });
                    
                    imagesHtml += '</div>';
                    
                    alertsHtml += `
                        <div class="safety-alert safety-critical mb-3">
                            <h5>Alerta: ${item.className} (${item.count} detecciones)</h5>
                            <p>Haga clic en las imágenes para ver en detalle:</p>
                            <div class="alert-evidence-container">
                                ${imagesHtml}
                            </div>
                        </div>
                    `;
                });
            } else {
                alertsHtml += `
                    <div class="safety-alert mb-3">
                        <h5>Sin Alertas Activas</h5>
                        <p>No se detectaron objetos en las clases seleccionadas para alertas. Continúe monitoreando según sea necesario.</p>
                    </div>
                `;
            }
            
            // Añadir recordatorio
            alertsHtml += `
                <div class="safety-alert mb-3">
                    <h5>Recordatorio: Monitoreo Continuo</h5>
                    <p>Recuerde revisar periódicamente la configuración de alertas para adaptarla a sus necesidades de monitoreo actuales.</p>
                </div>
            `;
            
            safetyAlerts.innerHTML = alertsHtml;
        }

        // Función global para mostrar imágenes en el modal (accesible desde HTML)
        window.showImageModal = function(imgSrc) {
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imgSrc;
            imageModal.show();
        };
    </script>
</body>
</html>
